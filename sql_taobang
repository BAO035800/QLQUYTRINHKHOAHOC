-- #############################################################
-- 1. BẢNG PHÂN QUYỀN (ROLES & PERMISSIONS)
-- #############################################################
-- Bảng Vai trò (Roles)
CREATE TABLE roles (
    id BIGSERIAL PRIMARY KEY,
    ten_vai_tro VARCHAR(50) UNIQUE NOT NULL,
    mo_ta TEXT
);
-- Bảng Quyền hạn (Permissions)
CREATE TABLE permissions (
    id BIGSERIAL PRIMARY KEY,
    permission_name VARCHAR(100) UNIQUE NOT NULL,
    mo_ta TEXT
);
-- Bảng Liên kết Người dùng - Vai trò (User_Roles)
CREATE TABLE user_roles (
    user_id UUID REFERENCES auth.users(id),
    role_id BIGINT REFERENCES roles(id),
    PRIMARY KEY (user_id, role_id)
);
-- Bảng Liên kết Vai trò - Quyền (Role_Permissions)
CREATE TABLE role_permissions (
    role_id BIGINT REFERENCES roles(id),
    permission_id BIGINT REFERENCES permissions(id),
    PRIMARY KEY (role_id, permission_id)
);
-- #############################################################
-- 2. BẢNG THỰC THỂ CƠ SỞ (CORE ENTITIES)
-- #############################################################
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_linh_vuc (
    id BIGSERIAL PRIMARY KEY,
    ten_linh_vuc TEXT,
    mo_ta_linh_vuc TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_chuyen_mon (
    id BIGSERIAL PRIMARY KEY,
    ten_chuyen_mon TEXT,
    mo_ta TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP
);
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_chu_de (
    id BIGSERIAL PRIMARY KEY,
    ten_chu_de TEXT,
    mo_ta TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP
);
-- Bảng Sinh viên (user_id là UUID)
CREATE TABLE Sinh_vien (
    id BIGSERIAL PRIMARY KEY,
    msv BIGINT,
    user_id UUID REFERENCES auth.users(id),
    UNIQUE (user_id)
);
-- Bảng Nhà khoa học (NVKH) (CHỦ YẾU SỬ DỤNG TRONG CÁC LỆNH UPDATE CỦA ADMIN)
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_nha_khoa_hoc (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) UNIQUE,
    ho VARCHAR(50),
    ten VARCHAR(50),
    email VARCHAR(100),
    sdt VARCHAR(20),
    linh_vuc_id BIGINT REFERENCES nckh_linh_vuc(id),
    chuyen_gia BOOLEAN,
    chuyen_mon_id BIGINT REFERENCES nckh_chuyen_mon(id),
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP,
    status INT
);
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_thongbao_dexuat (
    id BIGSERIAL PRIMARY KEY,
    ten VARCHAR(255),
    noi_dung TEXT,
    ngaybatdau DATE,
    ngayketthuc DATE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
CREATE TABLE nckh_thongbao_file (
    id SERIAL PRIMARY KEY,
    thongbao_id INT REFERENCES nckh_thongbao_dexuat(id),
    ten VARCHAR(255),
    duong_dang TEXT
);
-- 3. BẢNG DỰ ÁN & HỘI ĐỒNG (PROJECTS & COUNCILS)
-- Bảng Dự án (Du_an) (CHỦ YẾU LÀ UPDATE TRẠNG THÁI)
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_du_an (
    id BIGSERIAL PRIMARY KEY,
    ma TEXT,
    ten TEXT,
    cap_du_an INTEGER,
    thongbao_id INT REFERENCES nckh_thongbao_dexuat(id),
    linh_vuc_id INT REFERENCES nckh_linh_vuc(id),
    loai_hinh_nc INT,
    id_nguoitao UUID REFERENCES auth.users(id),
    vai_tro INT,
    trang_thai INT,
    ngay_gui TIMESTAMP,
    ngay_ket_thuc TIMESTAMP,
    thoi_gian INT,
    kinh_phi TEXT,
    kinh_phi_duyet TEXT,
    url_thuyet_minh TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
-- Bảng Lịch sử Trạng thái (nguoi_thuc_hien_id là UUID)
CREATE TABLE nckh_duan_lichsu_trangthai (
    id BIGSERIAL PRIMARY KEY,
    du_an_id BIGINT REFERENCES nckh_du_an(id),
    trang_thai_cu INT,
    trang_thai_moi INT,
    nguoi_thuc_hien_id UUID REFERENCES auth.users(id),
    thoi_gian_thay_doi TIMESTAMP DEFAULT NOW(),
    ghi_chu TEXT
);
-- Bảng File Dự án (user_id_nguoi_tao là UUID)
CREATE TABLE nckh_duan_file (
    id SERIAL PRIMARY KEY,
    du_an_id INT REFERENCES nckh_du_an(id),
    user_id_nguoi_tao UUID REFERENCES auth.users(id),
    url TEXT
);
-- Bảng Thành viên Dự án (id_thanh_vien là UUID)
CREATE TABLE nckh_du_an_thanh_vien (
    id BIGSERIAL PRIMARY KEY,
    du_an_id BIGINT REFERENCES nckh_du_an(id),
    id_thanh_vien UUID REFERENCES auth.users(id),
    role_thanh_vien VARCHAR(50),
    vai_tro INT,
    ngay_tham_gia TIMESTAMP,
    ngay_roi_di TIMESTAMP
);
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_hoi_dong_danh_gia (
    id BIGSERIAL PRIMARY KEY,
    ma VARCHAR(50),
    ten_hoi_dong TEXT,
    loai_hoi_dong VARCHAR(50),
    url_quyet_dinh TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    deleted_at TIMESTAMP
);
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_hoi_dong_thanh_vien (
    id BIGSERIAL PRIMARY KEY,
    nhakhoahoc_id BIGINT REFERENCES nckh_nha_khoa_hoc(id),
    hoi_dong_id BIGINT REFERENCES nckh_hoi_dong_danh_gia(id),
    vai_tro VARCHAR(50),
    danh_gia TEXT,
    diem INT,
    ghi_chu TEXT,
    url_bien_ban TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
CREATE TABLE nckh_hoidong_duan (
    id SERIAL PRIMARY KEY,
    hoidong_id INT REFERENCES nckh_hoi_dong_danh_gia(id),
    duan_id INT REFERENCES nckh_du_an(id),
    UNIQUE (hoidong_id, duan_id)
);
-- 4. BẢNG BÀI BÁO (PAPERS)
-- CHUẨN HÓA: satatus -> status, creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_bai_bao (
    id BIGSERIAL PRIMARY KEY,
    du_an_id BIGINT REFERENCES nckh_du_an(id),
    chu_de_id BIGINT REFERENCES nckh_chu_de(id),
    linh_vuc_id BIGINT REFERENCES nckh_linh_vuc(id),
    tieu_de TEXT,
    tom_tat TEXT,
    ten_tap_chi TEXT,
    so_phat_hanh VARCHAR(50),
    ngay_xuat_ban TIMESTAMP,
    so_trang BIGINT,
    ma_doi VARCHAR(100),
    url TEXT,
    loai INT,
    ten_hoi_thao VARCHAR(255),
    diaiem_hoithao VARCHAR(255),
    ngay_hoi_thao DATE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    status INT -- Đã sửa satatus
);
-- CHUẨN HÓA: creat_at -> created_at, upadte_at -> updated_at
CREATE TABLE nckh_baibao_thanhvien (
    id BIGSERIAL PRIMARY KEY,
    bai_bao_id INT REFERENCES nckh_bai_bao(id),
    user_id UUID REFERENCES auth.users(id),
    role_thanh_vien VARCHAR(50),
    vai_tro INT,
    ngay_tham_gia TIMESTAMP,
    ngay_roi_di TIMESTAMP
);